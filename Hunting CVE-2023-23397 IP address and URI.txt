// Title: Hunting CVE-2023-23397 IP address and URI
// By: Frankie Li
// On: 27-03-2023
// Artifacts: Microsoft-Windows-SMBClient/Connectivity event logs
// https://www.microsoft.com/en-us/security/blog/2023/03/24/guidance-for-investigating-attacks-using-cve-2023-23397/
//Search for activity around IoAs
let IoCs = dynamic(["<5.199.162.132>","<IP Address 2>"]);    // to be provided
let range = ago(30d);
union (DeviceProcessEvents | where Timestamp > range | where ProcessCommandLine has_any (IoCs)),
     (DeviceNetworkEvents | where Timestamp > range | where RemoteIP in (IoCs) or LocalIP in (IoCs)),
     (DeviceLogonEvents | where Timestamp > range | where RemoteIP in (IoCs))
| extend SignatureName = tostring(parse_json(AdditionalFields).SignatureName)
| project-reorder Timestamp, DeviceName, ActionType, LocalIP,RemoteIP, RemotePort,SignatureName,ProcessCommandLine
| sort by Timestamp desc