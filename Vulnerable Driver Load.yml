// Title: Detects the load of Living Off The Land Drivers 
// Desc: Detects the load of known vulnerable drivers 
// Ref: - https://www.loldrivers.io
// Ref: - https://www.reddit.com/r/crowdstrike/comments/13wjrgn/20230531_situational_awareness_spyboy_defense/
// MITRE: https://attack.mitre.org/techniques/T1543/003 (Privilege Escalation: Modify System Process
// Severity: high
// Trigger: 
// Usecase: Zemana Anti-Malware, Spyboy's "Terminator"
// Source: https://github.com/SigmaHQ/sigma/blob/master/rules/windows/driver_load/driver_load_win_vuln_drivers.yml
// By: Frankie Li
// On: 01-06-2023
// Platform: Microsoft Defender for Endpoint
let md5_hashes = dynamic(['1b5c3c458e31bede55145d0644e88d75',
    '6f5d54ab483659ac78672440422ae3f1',
    'ee6b1a79cb6641aa44c762ee90786fe0']);
let sha1_hashes = dynamic(['f0c463d29a5914b01e4607889094f1b7d95e7aaf',
    'a804ebec7e341b4d98d9e94f6e4860a55ea1638d',
    '96A7749D856CB49DE32005BCDD8621F38E2B4C05',
    'ecb4d096a9c58643b02f328d2c7742a38e017cf0',
    'c02f70960fa934b8defa16a03d7f6556',
    '839cbbc86453960e9eb6db814b776a40',
    'acac842a46f3501fe407b1db1b247a0b',
    '95e4c7b0384da89dce8ea6f31c3613d9',
    'e700a820f117f65e813b216fccbf78c9',
    '96b463b6fa426ae42c414177af550ba2',
    '27bcbeec8a466178a6057b64bef66512',
    '70dcd07d38017b43f710061f37cb4a91',
    'db72def618cbc3c5f9aa82f091b54250',
    '83601bbe5563d92c1fdb4e960d84dc77',
    '5970e8de1b337ca665114511b9d10806',
    '49fe3d1f3d5c2e50a0df0f6e8436d778',
    '1493d342e7a36553c56b2adea150949e',
    '4f191abc652d8f7442ca2636725e1ed6',
    '0ae30291c6cbfa7be39320badd6e8de0',
    'd104621c93213942b7b43d65b5d8d33e',
    'b89b097b8b8aecb8341d05136f334ebb',
    '14580bd59c55185115fd3abe73b016a2',
    '992ded5b623be3c228f32edb4ca3f2d2',
    'a26e600652c33dd054731b4693bf5b01',
    '1f950cfd5ed8dd9de3de004f5416fe20',
    '491aec2249ad8e2020f9f9b559ab68a8',
    'e4266262a77fffdea2584283f6c4f51d',
    'bd25be845c151370ff177509d95d5add',
    '9638f265b1ddd5da6ecdf5c0619dcbe6',
    '4e90cd77509738d30d3181a4d0880bfa',
    '0a6a1c9a7f80a2a5dcced5c4c0473765',
    '9aa7ed7809eec0d8bc6c545a1d18107a',
    'aa1ed3917928f04d97d8a217fe9b5cb1',
    '42f7cc4be348c3efd98b0f1233cf2d69',
    '4cc3ddd5ae268d9a154a426af2c23ef9',
    '2fed983ec44d1e7cffb0d516407746f2',
    'f7cbbb5eb263ec9a35a1042f52e82ca4',
    'ed6348707f177629739df73b97ba1b6e',
    '40bc58b7615d00eb55ad9ba700c340c1',
    'c3fea895fe95ea7a57d9f4d7abed5e71',
    '2128e6c044ee86f822d952a261af0b48',
    '3dbf69f935ea48571ea6b0f5a2878896',
    'c6f8983dd3d75640c072a8459b8fa55a',
    '6fcf56f6ca3210ec397e55f727353c4a',
    '79f7e6f98a5d3ab6601622be4471027f',
    'bae1f127c4ff21d8fe45e2bbfc59c180',
    'c533d6d64b474ffc3169a0e0fc0a701a',
    '3f39f013168428c8e505a7b9e6cba8a2',
    '748cf64b95ca83abc35762ad2c25458f',
    'bce7f34912ff59a3926216b206deb09f',
    '2d8e4f38b36c334d0a32a7324832501d',
    '47e6ac52431ca47da17248d80bf71389',
    '3651a6990fe38711ebb285143f867a43',
    'dc943bf367ae77016ae399df8e71d38a',
    '02198692732722681f246c1b33f7a9d9',
    'ddc2ffe0ab3fcd48db898ab13c38d88d',
    '0ec361f2fba49c73260af351c39ff9cb',
    'c1fce7aac4e9dd7a730997e2979fa1e2',
    '49938383844ceec33dba794fb751c9a5',
    '34069a15ae3aa0e879cd0d81708e4bcc',
    '1c294146fc77565030603878fd0106f9',
    'fd81af62964f5dd5eb4a828543a33dcf',
    'bd5b0514f3b40f139d8079138d01b5f6',
    'fa173832dca1b1faeba095e5c82a1559',
    '5cc5c26fc99175997d84fe95c61ab2c2',
    '1ed043249c21ab201edccb37f1d40af9',
    '361a598d8bb92c13b18abb7cac850b01',
    '9b359b722ac80c4e0a5235264e1e0156',
    '296bde4d0ed32c6069eb90c502187d0d',
    'd3e40644a91327da2b1a7241606fe559',
    '12cecc3c14160f32b21279c1a36b8338',
    'dd39a86852b498b891672ffbcd071c03',
    'b2a9ac0600b12ec9819e049d7a6a0b75',
    '444f538daa9f7b340cfd43974ed43690',
    '7b43dfd84de5e81162ebcfafb764b769',
    '13dda15ef67eb265869fc371c72d6ef0',
    '300c5b1795c9b6cc1bc4d7d55c7bbe85',
    '1392b92179b07b672720763d9b1028a5',
    '2e1f8a2a80221deb93496a861693c565',
    '8065a7659562005127673ac52898675f',
 'b5ada7fd226d20ec6634fc24768f9e22',
 '84fb76ee319073e77fb364bbbbff5461',
 'daf800da15b33bf1a84ee7afc59f0656',
 'f7393fb917aed182e4cbef25ce8af950',
 '120b5bbb9d2eb35ff4f62d79507ea63a',
 '73c98438ac64a68e88b7b0afd11ba140',
 '51207adb8dab983332d6b22c29fe8129',
 '4a23e0f2c6f926a41b28d574cbc6ac30',
 '20125794b807116617d43f02b616e092',
 'e8ebba56ea799e1e62748c59e1a4c586',
 '8abbb12e61045984eda19e2dc77b235e',
 'f66b96aa7ae430b56289409241645099',
 '97e3a44ec4ae58c8cc38eefc613e950e',
 'ff7b31fa6e9ab923bce8af31d1be5bb2',
 '12908c285b9d68ee1f39186110df0f1e',
 '6126065af2fc2639473d12ee3c0c198e',
 '356bda2bf0f6899a2c08b2da3ec69f13',
 'fd7de498a72b2daf89f321d23948c3c4',
 '338a98e1c27bc76f09331fcd7ae413a5',
 'c9a293762319d73c8ee84bcaaf81b7b3',
 'e9e786bdba458b8b4f9e93d034f73d00',
 'a17c58c0582ee560c72f60764ed63224',
 '21e13f2cb269defeae5e1d09887d47bb',
 'a57b47489febc552515778dd0fd1e51c',
 'd6e9f6c67d9b3d790d592557a7d57c3c',
 '76bb1a4332666222a8e3e1339e267179',
 '1cd158a64f3d886357535382a6fdad75',
 'd9e7e5bcc5b01915dbcef7762a7fc329',
 'd253c19194a18030296ae62a10821640',
 'b12d1630fd50b2a21fd91e45d522ba3a',
 '50b39072d0ee9af5ef4824eca34be6e3',
 '778b7feea3c750d44745d3bf294bd4ce',
 '0761c357aed5f591142edaefdf0c89c8',
 '23cf3da010497eb2bf39a5c5a57e437c',
 'c49a1956a6a25ffc25ad97d6762b0989',
 'f406c5536bcf9bacbeb7ce8a3c383bfa',
 'f2f728d2f69765f5dfda913d407783d2',
 '4b817d0e7714b9d43db43ae4a22a161e',
 '715f8efab1d1c660e4188055c4b28eed',
 'a01c412699b6f21645b2885c2bae4454',
 '010c0e5ac584e3ab97a2daf84cf436f5',
 'd5db81974ffda566fa821400419f59be',
 '3247014ba35d406475311a2eab0c4657',
 '4d487f77be4471900d6ccbc47242cc25',
 '1f2888e57fdd6aee466962c25ba7d62d',
 '507a649eb585d8d0447eab0532ef0c73',
 '4ad8fd9e83d7200bd7f8d0d4a9abfb11',
 'cd9f0fcecf1664facb3671c0130dc8bb',
 'b10b210c5944965d0dc85e70a0b19a42',
 'ae5eb2759305402821aeddc52ba9a6d6',
 'f5051c756035ef5de9c4c48bacb0612b',
 '1898ceda3247213c084f43637ef163b3',
 '37086ae5244442ba552803984a11d6cb',
 '825703c494e0d270f797f1ecf070f698',
 '909f3fc221acbe999483c87d9ead024a',
 '75d6c3469347de1cdfa3b1b9f1544208',
 '9ab9f3b75a2eb87fafb1b7361be9dfb3',
 '5f9785e7535f8f602cb294a54962c9e7',
 '7d46d0ddaf8c7e1776a70c220bf47524',
 'f9844524fb0009e5b784c21c7bad4220',
 '828bb9cb1dd449cd65a29b18ec46055f',
 '4d17b32be70ef39eae5d5edeb5e89877',
 '2391fb461b061d0e5fccb050d4af7941',
 '6d4159694e1754f262e326b52a3b305a',
 'a60c9173563b940203cf4ad38ccf2082',
 '63e333d64a8716e1ae59f914cb686ae8',
 'a9f220b1507a3c9a327a99995ff99c82',
 'c5f5d109f11aadebae94c77b27cb026f',
 '5bab40019419a2713298a5c9173e5d30',
 'c996d7971c49252c582171d9380360f2',
 '98763a3dee3cf03de334f00f95fc071a',
 'e79c91c27df3eaf82fb7bd1280172517',
 'a42249a046182aaaf3a7a7db98bfa69d',
 '803a371a78d528a44ef8777f67443b16',
 '9007c94c9d91ccff8d7f5d4cdddcc403',
 '11fb599312cb1cf43ca5e879ed6fb71e',
 '7f9309f5e4defec132b622fadbcad511',
 '04a88f5974caa621cee18f34300fc08a',
 '8636fe3724f2bcba9399daffd6ef3c7e',
 '9dfd73dadb2f1c7e9c9d2542981aaa63',
 '490b1f404c4f31f4538b36736c990136',
 'c1d063c9422a19944cdaa6714623f2ec',
 'dacb62578b3ea191ea37486d15f4f83c',
 '2da209dde8188076a9579bd256dc90d0',
 '0ba6afe0ea182236f98365bd977adfdf',
 '4c016fd76ed5c05e84ca8cab77993961',
 'ad22a7b010de6f9c6f39c350a471a440',
 '79483cb29a0c428e1362ec8642109eee',
 'a179c4093d05a3e1ee73f6ff07f994aa',
 'ccf523b951afaa0147f22e2a7aae4976',
 '736c4b85ce346ddf3b49b1e3abb4e72a',
 'b0baac4d6cbac384a633c71858b35a2e',
 '798de15f187c1f013095bbbeb6fb6197',
 'a86150f2e29b35369afa2cafd7aa9764',
 'b941c8364308990ee4cc6eadf7214e0f',
 'dd04cd3de0c19bede84e9c95a86b3ca8',
 '6909b5e86e00b4033fedfca1775b0e33',
 '9b91a44a488e4d539f2e55476b216024',
 '8b287636041792f640f92e77e560725e',
 '07f83829e7429e60298440cd1e601a6a',
 '0395b4e0eb21693590ad1cfdf7044b8b',
 '4b058945c9f2b8d8ebc485add1101ba5',
 '0067c788e1cb174f008c325ebde56c22',
 'c2c1b8c00b99e913d992a870ed478a24',
 '84ba7af6ada1b3ea5efb9871a0613fc6',
 'dbc415304403be25ac83047c170b0ec2',
 '31469f1313871690e8dc2e8ee4799b22',
 '2d465b4487dc81effaa84f122b71c24f',
 '64efbffaa153b0d53dc1bccda4279299',
 'b164daf106566f444dfb280d743bc2f7',
 '7c72a7e1d42b0790773efd8700e24952',
 '56a515173b211832e20fbc64e5a0447c',
 'c2eb4539a4f6ab6edd01bdc191619975',
 'd1bac75205c389d6d5d6418f0457c29b',
 '68dde686d6999ad2e5d182b20403240b',
 'a785b3bc4309d2eb111911c1b55e793f',
 '6ab7b8ef0c44e7d2d5909fdb58d37fa5',
 'd9ce18960c23f38706ae9c6584d9ac90',
 'ab53d07f18a9697139ddc825b466f696',
 'ba5f0f6347780c2ed911bbf888e75bef',
 '13ee349c15ee5d6cf640b3d0111ffc0e',
 '9a237fa07ce3ed06ea924a9bed4a6b99',
 'fa222bed731713904320723b9c085b11',
 '0898af0888d8f7a9544ef56e5e16354e',
 'e076dadf37dd43a6b36aeed957abee9e',
 '4f27c09cc8680e06b04d6a9c34ca1e08',
 '1b32c54b95121ab1683c7b83b2db4b96',
 '715572dfe6fb10b16f980bfa242f3fa5',
 '4a06bcd96ef0b90a1753a805b4235f28',
 'f242cffd9926c0ccf94af3bf16b6e527',
 '7ed6030f14e66e743241f2c1fa783e69',
 '0d6fef14f8e1ce5753424bd22c46b1ce',
 'a4fda97f452b8f8705695a729f5969f7',
 '62c18d61ed324088f963510bae43b831',
 'd5a642329cce4df94b8dc1ba9660ae34',
 'a641e3dccba765a10718c9cb0da7879e',
 'ed07f1a8038596574184e09211dfc30f',
 '3473faea65fba5d4fbe54c0898a3c044',
 '708ac9f7b12b6ca4553fd8d0c7299296',
 'bbe4f5f8b0c0f32f384a83ae31f49a00',
 '257483d5d8b268d0d679956c7acdf02d',
 '312e31851e0fc2072dbf9a128557d6ef',
 '14eead4d42728e9340ec8399a225c124',
 'de1cc5c266140bff9d964fab87a29421',
 '9a9dbf5107848c254381be67a4c1b1dd',
 '1dc94a6a82697c62a04e461d7a94d0b0',
 '2850608430dd089f24386f3336c84729',
 '6d131a7462e568213b44ef69156f10a5',
 'b8b6686324f7aa77f570bc019ec214e6',
 '22823fed979903f8dfe3b5d28537eb47',
 'c1d3a6bb423739a5e781f7eee04c9cfd',
 '0c0195c48b6b8582fa6f6373032118da',
 '5228b7a738dc90a06ae4f4a7412cb1e9',
 '62f02339fe267dc7438f603bfb5431a1',
 '22949977ce5cd96ba674b403a9c81285',
 '5ca1922ed5ee2b533b5f3dd9be20fd9a',
 '1ed08a6264c5c92099d6d1dae5e8f530',
 'b0770094c3c64250167b55e4db850c04',
 'a6e9d6505f6d2326a8a9214667c61c67',
 '8407ddfab85ae664e507c30314090385',
 '9321a61a25c7961d9f36852ecaa86f55',
 'a711e6ab17802fabf2e69e0cd57c54cd',
 '29ccff428e5eb70ae429c3da8968e1ec',
 '79df0eabbf2895e4e2dae15a4772868c',
 'fb7c61ef427f9b2fdff3574ee6b1819b',
 'f778489c7105a63e9e789a02412aaa5f',
 'fef9dd9ea587f8886ade43c1befbdafe',
 '43830326cd5fae66f5508e27cbec39a0',
 'c7a57cd4bea07dadba2e2fb914379910',
 'f1e054333cc40f79cfa78e5fbf3b54c2',
 'dc564bac7258e16627b9de0ce39fae25',
 '054299e09cea38df2b84e6b29348b418',
 '97221e16e7a99a00592ca278c49ffbfc',
 '8d63e1a9ff4cafee1af179c0c544365c',
 '96421b56dbda73e9b965f027a3bda7ba',
 '4ae55080ec8aed49343e40d08370195c',
 '988dabdcf990b134b0ac1e00512c30c4',
 'bbbc9a6cc488cfb0f6c6934b193891eb',
 '76c643ab29d497317085e5db8c799960',
 'e9a30edef1105b8a64218f892b2e56ed',
 '7bd840ff7f15df79a9a71fec7db1243e',
 '1cff7b947f8c3dea1d34dc791fc78cdc',
 '2c54859a67306e20bfdc8887b537de72',
 'a5f637d61719d37a5b4868c385e363c0',
 '2509a71a02296aa65a3428ddfac22180',
 '6cce5bb9c8c2a8293df2d3b1897941a2',
 '7a16fca3d56c6038c692ec75b2bfee15',
 'eaea9ccb40c82af8f3867cd0f4dd5e9d',
 'd2588631d8aae2a3e54410eaf54f0679',
 'b47dee29b5e6e1939567a926c7a3e6a4',
 'fac8eb49e2fd541b81fcbdeb98a199cb',
 '1a234f4643f5658bab07bfa611282267',
 '0752f113d983030939b4ab98b0812cf0']);
let share256_hashes = dynamic(['15c53eb3a0ea44bbd2901a45a6ebeae29bb123f9c1115c38dfb2cdbec0642229',
    'ff6729518a380bf57f1bc6f1ec0aa7f3012e1618b8d9b0f31a61d299ee2b4339',
    'f088b2ba27dacd5c28f8ee428f1350dca4bc7c6606309c287c801b2e1da1a53d']);
DeviceFileEvents | where MD5 has_any(md5_hashes) or 
    SHA1 has_any (sha1_hashes) or 
    SHA256 has_any (share256_hashes)